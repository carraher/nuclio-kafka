metadata:
  name: mutate
spec:
  description: "Showcases unstructured logging and a structured response."
  handler: "main:handler"
  runtime: "python:3.6"
  resources: {}
  image: "nuclio/processor-mutate:latest"
  minReplicas: 1
  maxReplicas: 1
  triggers:
    kafka_mutate:
      class: ""
      kind: kafka-cluster
      attributes:
        brokers:
        - 'kafka-hub-0.kafka-hub-headless.nuclio.svc.cluster.local:9092'
        consumerGroup: ingest_cg
        initialOffset: latest
        sasl:
          enable: false
          password: ""
          user: ""
        topics:
          - ingest
  build:
    registry: "127.0.0.1:31500"
    image: ""
    noCache: false
    offline: false
    dependencies: []
    runtimeAttributes:
      repositories: []
    functionSourceCode: aW1wb3J0IGpzb24KaW1wb3J0IG9zCmltcG9ydCB0aW1lCmZyb20ga2Fma2EgaW1wb3J0IEthZmthUHJvZHVjZXIKCiMgZGVmIGluaXRfY29udGV4dChjb250ZXh0KToKZGVmIGhhbmRsZXIoY29udGV4dCwgZXZlbnQpOgogICAgY29udGV4dC5sb2dnZXIuaW5mbygnbXV0YXRlLmhhbmRsZXIgYmVnaW4nKQogICAgdHJ5OgogICAgICAgIHByb2R1Y2VyID0gS2Fma2FQcm9kdWNlcihib290c3RyYXBfc2VydmVycz1vcy5nZXRlbnYoJ0tBRktBJyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlX3NlcmlhbGl6ZXI9bGFtYmRhIHg6IGpzb24uZHVtcHMoeCkuZW5jb2RlKCd1dGYtOCcpLGFwaV92ZXJzaW9uPSgyLCAyLCAwKSkKICAgICAgICAKICAgICAgICBwYXlsb2FkID0ganNvbi5sb2FkcyhldmVudC5ib2R5KQogICAgICAgIHBheWxvYWRbJ211dGF0ZSddID0gJ3dhcyBoZXJlJwogICAgICAgIHRpbWUuc2xlZXAoaW50KG9zLmdldGVudignU0xFRVAnLCAzKSkpCiAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbygnbXV0YXRlLmhhbmRsZXIgc2VuZGluZzogJyArIHN0cihwYXlsb2FkKSkKCiAgICAgICAgcHJvZHVjZXIuc2VuZChvcy5nZXRlbnYoJ0tBRktBX1RPUElDX09VVCcpLCB2YWx1ZT1wYXlsb2FkKQogICAgICAgIHByb2R1Y2VyLmZsdXNoKCkKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBjb250ZXh0LmxvZ2dlci5lcnJvcignbXV0YXRlLmhhbmRsZXIgRXhjZXB0aW9uOiAnICsgc3RyKGUpKQogICAgICAgIHJhaXNlCgogICAgY29udGV4dC5sb2dnZXIuaW5mbygnbXV0YXRlLmhhbmRsZXIgZW5kJykKCiAgICByZXR1cm4gY29udGV4dC5SZXNwb25zZShib2R5PSdNdXRhdGUgc2VudCBtZXNzYWdlIHRvIG51Y2xpb2V2ZW50cyB0b3BpYycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWFkZXJzPXt9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGVudF90eXBlPSd0ZXh0L3BsYWluJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1c19jb2RlPTIwMCkK
    commands:
      - 'pip install msgpack'
      - 'pip install nuclio_sdk'
      - 'pip install kafka-python==2.0.2'
    codeEntryType: sourceCode
    onbuildImage: "quay.io/nuclio/handler-builder-python-onbuild:1.7.11-amd64"
  platform: {}
  env:
  - name: KAFKA
    value: "kafka-hub-0.kafka-hub-headless.nuclio.svc.cluster.local:9092"
  - name: KAFKA_TOPIC_OUT
    value: "nuclioevents"
  readinessTimeoutSeconds: 60